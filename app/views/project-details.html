{% extends "/layouts/main.html" %}

{% block pageTitle %}{{ project.name }}{% endblock %}

{# Back link - in place of breadcrumbs #}
{% block breadcrumbs %}
<div class="ds_wrapper">
  <a class="ds_back-link" href="javascript:window.history.back()">Back</a>
</div>
{% endblock %}

{% block main %}
<div class="ds_wrapper">
  <main id="main-content">
    {% block mainHeader %}
    <div class="ds_layout">
      <div class="ds_layout__header">
        <header class="ds_page-header">
          <h1 class="ds_page-header__title">{{ project.name }}</h1>
          {% if not authenticated %}
          <p class="ds_page-header__description">
            {{ project.category }} - {{ project.type }}
          </p>
          {% endif %}
        </header>
      </div>
    </div>
    {% endblock %}

    {% block mainContent %}
    <div class="ds_layout__content">
      <h2 class="ds_section__title">Project details</h2>
      <ol class="ds_summary-list">
        {% set projectFields = [
          { key: "Category", value: project.category, id: "field-category" },
          { key: "Type", value: project.type, id: "field-type" },
          { key: "Standard Name", value: project.standard_name, id: "field-standard" },
          { key: "Status", value: data['statusEnum'][project.status], id: "field-status" },
          { key: "PIUs Listed", value: project.pius_listed, id: "field-pius" },
          { key: "Validator", value: project.validator, id: "field-validator" },
          { key: "Developer", value: project.developer, id: "field-developer" },
          { key: "Country", value: project.country, id: "field-country" },
          { key: "Address", value: project.address, id: "field-address" }
        ] %}

        {% for field in projectFields %}
          <li class="ds_summary-list__item">
            <span class="ds_summary-list__key" id="{{ field.id }}">{{ field.key }}</span>
            <span class="ds_summary-list__value">
              <q class="ds_summary-list__answer">{{ field.value }}</q>
            </span>
            {% if authenticated %}
              <div class="ds_summary-list__actions">
                <button type="button" class="ds_link" aria-describedby="{{ field.id }}">Change</button>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </div>
    <div class="ds_layout__sidebar">
      <h2 class="ds_layout__sidebar-title">Site Map</h2>
      <div id="map" style="width: 100%; height: 400px;"></div>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""/>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@0.3.1/os-api-branding.css" />
      <script src="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@0.3.1/os-api-branding.js"></script>
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
              integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
              crossorigin=""></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.15.0/proj4.js"></script>

      <script>
        proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs");
        proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");

        async function getCoordinatesFromAddress(address) {
          const endpoint = `https://api.os.uk/search/places/v1/find?key=${apiKey}&query=${encodeURIComponent(address)}`;

          try {
            const response = await fetch(endpoint);
            if (!response.ok) {
              throw new Error(`Error: ${response.status} - ${response.statusText}`);
            }

            const data = await response.json();
            if (data.results && data.results.length > 0) {
              const { DPA } = data.results[0];
              const [longitude, latitude] = proj4(
                "EPSG:27700", // OSGB36
                "EPSG:4326", // WGS84
                [DPA.X_COORDINATE, DPA.Y_COORDINATE]
              );
              return { latitude, longitude };
            } else {
              throw new Error("No results found for the given address.");
            }
          } catch (error) {
            console.error("Failed to fetch coordinates:", error);
            return null;
          }
        }

        document.addEventListener("DOMContentLoaded", async function () {
          const { latitude, longitude } = await getCoordinatesFromAddress("{{ project.address }}");
          const map = L.map("map", {
            attributionControl: false,
            center: [latitude, longitude],
            zoom: 10,
          });

          L.tileLayer(`https://api.os.uk/maps/raster/v1/zxy/Outdoor/{z}/{x}/{y}.png?key=${apiKey}`, {
            maxZoom: 17,
          }).addTo(map);

          var marker = L.marker([latitude,longitude]).addTo(map);
          marker.bindPopup("<b>{{ project.name }}</b><br>{{ project.address }}").openPopup();
        });
      </script>
    </div>
    {% endblock %}
  </main>
</div>
{% endblock %}
